#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

# 1) decide provider
if [ -n "${TS_FORCE_PROVIDER:-}" ]; then
  PROVIDER="$TS_FORCE_PROVIDER"
else
  # ask switchboard; fall back to "local" if anything fails
  PROVIDER="$( (echo '{"method":"route","args":{}}' \
    | python3 "$SCRIPT_DIR/../agents/switchboard_mcp.py" \
    | jq -r '.data.provider // empty') 2>/dev/null || true)"
  [ -n "$PROVIDER" ] || PROVIDER="local"
fi

# 2) map provider â†’ CLI
case "$PROVIDER" in
  local)      CLI_BIN="$SCRIPT_DIR/local_ai.sh" ;;
  openrouter) CLI_BIN="goose" ;;
  gemini)     CLI_BIN="gemini" ;;
  anthropic)  CLI_BIN="anthropic" ;;
  openai)     CLI_BIN="openai" ;;
  *)          echo "Unknown provider: $PROVIDER" >&2; exit 2 ;;
esac

# 3) run via token-aware runner (handles rotation/circuit-breakers/mapping)
exec "$SCRIPT_DIR/run_with_token.sh" "$PROVIDER" "$CLI_BIN" "$@"
